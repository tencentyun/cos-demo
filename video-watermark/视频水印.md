## 概览

数据万象支持将图片、字符串隐藏在视频、图文中，不容易被探知和再次修改，并且具有不破坏视频与图文载体的完整性与可观赏性。通过隐藏在内容载体中的水印，可以达到确认内容创作者、版权所有者、传播者，判断视频内容是否被篡改的目的。

## 业务场景

### 版权保护

数据万象支持同步为媒体资源添加多个水印，提升品牌影响力的同时，减少媒体文件被盗可能性；同时支持静态动态图片、文字等多种水印格式，满足您多场景下的水印需求。

## 准备工作

- 已创建和绑定存储桶，详情请参见 [存储桶操作](https://cloud.tencent.com/document/product/460/46483)。
- 已 [开通媒体处理](https://cloud.tencent.com/document/product/460/87745) 功能。
- [上传视频文件](https://cloud.tencent.com/document/product/436/13321)

- 在页面中引入 [COS SDK](https://cloud.tencent.com/document/product/436/11459) 

```
    <!--COS SDK-->
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

```

## 生成视频水印文件

### 步骤 1：初始化 COS SDK 并配置相关信息

```js
// 密钥请在访问管理控制台获取。https://console.cloud.tencent.com/cam/capi
const cos = new COS({
  SecretId: 'AKID*******',
  SecretKey: '**********',
});
```

#### 步骤 2：创建视频水印任务

构造提交视频水印任务接口并发起请求 [请求参数](https://cloud.tencent.com/document/product/460/76913)：

```js
// 存储桶配置请在cos控制台获取。https://console.cloud.tencent.com/cos/bucket
    // 格式参考：Bucket: 'abc-1250000000', Region: 'ap-shanghai'
    // 源文件相关配置
    const InputConf = {
      Bucket: '***-125********',
      Region: '**-*****',
      FileName: 'demo.mp4',
      WaterMark: 'demo.png'
    };
    // 水印结果文件相关配置，注意：需与源文件所在存储桶为同地域
    const OutputConf = {
      Bucket: '***-125********',
      Region: 'ap-chongqing',
      FileName: 'demo.mp4',
    };
//需在地址前拼接/jobs，即：`https://<BucketName-APPID>.ci.<Region>.myqcloud.com/jobs
const host = config.Bucket + '.ci.' + config.Region + '.myqcloud.com';
const url = 'https://' + host + '/jobs';
const ImageWaterMark = config.Bucket + '.cos.' + config.Region + '.myqcloud.com/' + InputConf.WaterMark
//使用cos sdk 发起视频水印任务请求

// 文字水印
const body = COS.util.json2xml({
  Request: {
          "Tag": "Transcode", /* 创建任务的 Transcode ,必须*/
          "Input": {
            "Object": InputConf.FileName, /* 需要的视频文件，存储桶里的路径，必须 */
          },
          "Operation": {
            "Output": {
              "Region": OutputConf.Region, /* 存储桶的地域，必须 */
              "Bucket": OutputConf.Bucket, /* 存储结果的存储桶，必须 */
              "Object": OutputConf.FileName /* 输出结果的文件名，必须 */
            },
            "Transcode": {
                "Audio": {"Codec": "aac"},
                "Container": {"Format": "mp4"},
                "Video": {"Codec": "H.264"}
            },
            "Watermark": {
                "Dx": "10", // 水平偏移
                "Dy": "10", // 垂直偏移
                "LocMode": "Absolute", //偏移方式 Relativity：按比例，Absolute：固定位置
                "Pos": "TopRight", // 基准位置 TopRight、TopLeft、BottomRight、BottomLeft、Left、Right、Top、Bottom、Center
                "SlideConfig": { // 水印滑动配置，配置该参数后水印位移设置不生效
                    "SlideMode": "Default", // 滑动模式, Default: 默认不开启、ScrollFromLeft: 从左到右滚动
                    "XSlideSpeed": "1", // 横向滑动速度
                    "YSlideSpeed": "1" // 纵向滑动速度
                },
                "Text": { // 文本水印节点
                    "FontColor": "0xFF0000", // 字体颜色
                    "FontSize": 32, // 字体大小
                    "FontType": "simfang.ttf", // 字体类型
                    "Text": "数据万象", // 水印内容
                    "Transparency": "75" // 透明度
                },
                "Type": "Text" // 水印类型  Text：文字水印、 Image：图片水印
            }
          }
        },
});

// 图片水印
const body = COS.util.json2xml({
  Request: {
          "Tag": "Transcode", /* 创建任务的 Transcode ,必须*/
          "Input": {
            "Object": InputConf.FileName, /* 需要的文档文件，存储桶里的路径，必须 */
          },
          "Operation": {
            "Output": {
              "Region": OutputConf.Region, /* 存储桶的地域，必须 */
              "Bucket": OutputConf.Bucket, /* 存储结果的存储桶，必须 */
              "Object": OutputConf.FileName /* 输出结果的文件名，必须 */
            },
            "Transcode": {
                "Audio": {"Codec": "aac"},
                "Container": {"Format": "mp4"},
                "Video": {"Codec": "H.264"}
            },
            "Watermark": {
                "Dx": "10", // 水平偏移
                "Dy": "10", // 垂直偏移
                "LocMode": "Absolute", //偏移方式 Relativity：按比例，Absolute：固定位置
                "Pos": "TopRight", // 基准位置 TopRight、TopLeft、BottomRight、BottomLeft、Left、Right、Top、Bottom、Center
                "SlideConfig": { // 水印滑动配置，配置该参数后水印位移设置不生效
                    "SlideMode": "Default", // 滑动模式, Default: 默认不开启、ScrollFromLeft: 从左到右滚动
                    "XSlideSpeed": "1", // 横向滑动速度
                    "YSlideSpeed": "1" // 纵向滑动速度
                },
                "image": {
                    "Height": 10, // 高
                    "Width": 10, // 宽
                    "Mode": "Original", //尺寸模式 1. Original：原有尺寸,2. Proportion：按比例,3. Fixed：固定大小
                    "Transparency": "75", // 透明度
                    "Url": ImageWaterMark // 水印图地址
                }
                "Type": "Image" // 水印类型  Text：文字水印、 Image：图片水印
            }
          }
        },
});


const body = COS.util.json2xml(param);

cos.request(
  {
    Bucket: InputConf.Bucket,
    Region: InputConf.Region,
    Method: 'POST',
    Url: 'https://' + host + '/jobs',
    Key: '/jobs', /** 固定值，必须 */
    ContentType: 'application/xml', /** 固定值，必须 */
    Body: body
  },
  (err, data) => {
    console.log(err || data);
  }
);
```

- 请求方式为 POST，Content-Type 为 application/xml，Tag 为 Transcode，Input.Object 为 准备工作中上传的 视频文件,Operation.Output 为结果输出地址可以填准备工作中创建的存储桶，需要注意 Output.Object 文件名称后缀名应为 **.mp4** 格式，Operation.Watermark 为视频水印配置参数。

- [接口响应](https://cloud.tencent.com/document/product/460/76913#.E5.93.8D.E5.BA.94)参数，JobsDetail 节点下为下面 **获取视频水印任务接口响应** 任务信息。其中 JobId 为关键信息，下面 **构造查询视频水印任务链接** 会用到。

#### 步骤 3：获取视频水印文件

[查询视频水印任务](https://cloud.tencent.com/document/product/460/84765#.E8.AF.B7.E6.B1.82)执行是否完成，获取结果文件

```js

// 需在对象地址前面拼接 jobs/<jobId>，即：`https://<BucketName-APPID>.ci.<Region>.myqcloud.com/jobs/<jobId>`
// jobId 即为刚刚创建的任务 ID

const host = InputConf.Bucket + '.ci.' + InputConf.Region + '.myqcloud.com';

const url = 'https://' + host + '/jobs/' + JobId;
cos.request(
  {
    Bucket: InputConf.Bucket,
    Region: InputConf.Region,
    Method: 'GET',
    Url: url,
    Key: '/jobs/' + JobId /** 固定值，必须 */,
    ContentType: 'application/xml' /** 固定值，必须 */,
  },
  (err, data) => {
    if (err) {
      // 视频水印任务查询失败，请在console查看报错信息;
      console.log(JSON.stringify(err));
      return;
    }
    const resp = data.Response || {};
    //判断视频水印任务是否执行中
    if (resp.JobsDetail.State !== 'Success') {
      console.log('...视频水印任务执行中');
      return;
    }
    //任务执行完成 水印文件地址为
    const srtUrl = `https://${OutputConf.Bucket}.cos.${OutputConf.Region}.myqcloud.com/${OutputConf.FileName}`;
  }
);
```

- 返回体 Content-Type 为 application/xml，其中 State 为 Success 代表已经完成视频水印，读取到视频水印文件地址为 https://${OutputConf.Bucket}.cos.${OutputConf.Region}.myqcloud.com/${OutputConf.Object}。

